# 'vault' Package

## Description

A package for Vault, a tool for secrets management, encryption as a service, and privileged access management.

## Storage
By default, it's in standalone (in-memory) storage.
For database storage, you need to add `vault-database` package and the right context.

## Values

| Name                                | Type    | Default                                                                     | Description                                                                                                                          |
|-------------------------------------|---------|-----------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------|
| vault.image.repository              | string  |                                                                             | Image repository                                                                                                                     |
| vault.image.tag                     | string  |                                                                             | Image tag                                                                                                                            |
| vault.injector.image.repository     | string  |                                                                             | Injector image repository                                                                                                            |
| vault.injector.image.tag            | string  |                                                                             | Injector image tag                                                                                                                   |
| vault.ingress.host                  | string  | vault.\<environment\>.\<project\>.\<organization\>.local:<ingressHttpsPort> | Ingress host                                                                                                                         |
| vault.ha.enabled                    | bool    |                                                                             | Enable Vault HA                                                                                                                      |
| vault.ha.replicas                   | integer |                                                                             | Define how many Vault HA replicas                                                                                                    |
| vault.ha.raft                       | bool    |                                                                             | Enable HA using Raft                                                                                                                 |
| vault.storage.postgresql.enabled    | bool    |                                                                             | Enable PostgreSQL storage backend                                                                                                    |
| vault.storage.postgresql.username   | string  |                                                                             | PostgreSQL username                                                                                                                  |
| vault.storage.postgresql.password   | string  |                                                                             | PostgreSQL password                                                                                                                  |
| vault.storage.postgresql.dbname     | string  |                                                                             | PostgreSQL database name                                                                                                             |
| vault.storage.postgresql.host       | string  |                                                                             | PostgreSQL server                                                                                                                    |
| vault.storage.postgresql.ha_enabled | bool    |                                                                             | PostgreSQL HA enabled                                                                                                                |
| vault.tls.ca.srcFilePath            | string  |                                                                             | SSL/TLS trusted certificate authorities source file path (PEM bundle)                                                                |
| vault.tls.ca.dstFilePath            | string  | /ssl/certs/ca-certificates.crt                                              | SSL/TLS trusted certificate authorities destination file path (PEM bundle)                                                           |
| vault.seal.\<mechanism\>            | object  | {}                                                                          | See [`https://developer.hashicorp.com/vault/docs/configuration/seal`](https://developer.hashicorp.com/vault/docs/configuration/seal) |
| vault.serviceAccount.annotations    | object  | {}                                                                          | Service account annotations                                                                                                          |

### Authentication methods

#### OIDC

| Name                                    | Type   | Default | Description                                 |
|-----------------------------------------|--------|---------|---------------------------------------------|
| vault.auth.oidc.clientId                | string |         | OIDC Provider client id                     |
| vault.auth.oidc.clientSecret            | string |         | OIDC Provider client secret                 |
| vault.auth.oidc.discoveryUrl            | string |         | OIDC Provider discovery URL                 |
| vault.auth.oidc.oidcScopes              | string |         | OIDC Provider Scopes                        |
| vault.auth.oidc.policies[`{i}`].name    | string |         | Auth Policy name                            |
| vault.auth.oidc.policies[`{i}`].content | string |         | Auth Policy content                         |
| vault.auth.oidc.roles[`{i}`].name       | string |         | Vault OIDC Role name                        |
| vault.auth.oidc.roles[`{i}`].groupName  | string |         | Entra ID Group name used by Vault OIDC Role |
| vault.auth.oidc.roles[`{i}`].groupId    | string |         | Entra ID Group ID used by Vault OIDC Role   |
| vault.auth.oidc.roles[`{i}`].policies   | list   |         | Entra ID Policies used by Vault OIDC Role   |

### PKI

#### Root CA
| Name                                 | Type    | Default | Description                                                                                                                                                                                                                                                                                                                                                                                                                              |
|--------------------------------------|---------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| vault.pki.bootstrapRootCa            | bool    | false   | Create Root CA after enabling                                                                                                                                                                                                                                                                                                                                                                                                            |
| vault.pki.enabled                    | bool    | false   | Enable PKI secrets engine                                                                                                                                                                                                                                                                                                                                                                                                                |
| vault.pki.rootCa.altNames            | string  |         | Specifies the requested Subject Alternative Names, in a comma-delimited list. These can be host names or email addresses; they will be parsed into their respective fields                                                                                                                                                                                                                                                               |
| vault.pki.rootCa.commonName          | string  |         | Specifies the requested CN for the certificate. If more than one common_name is desired, specify the alternative names in the alt_names list                                                                                                                                                                                                                                                                                             |
| vault.pki.rootCa.country             | string  |         | Specifies the C (Country) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                       |
| vault.pki.rootCa.excludeCnFromSans   | bool    |         | If true, the given common_name will not be included in DNS or Email Subject Alternate Names (as appropriate). Useful if the CN is not a hostname or email address, but is instead some human-readable identifier                                                                                                                                                                                                                         |
| vault.pki.rootCa.issuerName          | string  |         | Provides a name to the specified issuer. The name must be unique across all issuers and not be the reserved value default                                                                                                                                                                                                                                                                                                                |
| vault.pki.rootCa.keyBits             | integer |         | Specifies the number of bits to use for the generated keys. Allowed values are 0 (universal default); with key_type=rsa, allowed values are: 2048 (default), 3072, 4096 or 8192; with key_type=ec, allowed values are: 224, 256 (default), 384, or 521; ignored with key_type=ed25519                                                                                                                                                    |
| vault.pki.rootCa.keyType             | string  |         | Specifies the desired key type; must be `rsa`, `ed25519` or `ec`                                                                                                                                                                                                                                                                                                                                                                         |
| vault.pki.rootCa.locality            | string  |         | Specifies the L (Locality) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                      |
| vault.pki.rootca.maxLeaseTtl         | string  |         | The maximum lease TTL for this secrets engine                                                                                                                                                                                                                                                                                                                                                                                            |
| vault.pki.rootCa.organization        | string  |         | Specifies the O (Organization) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                  |
| vault.pki.rootCa.ou                  | string  |         | Specifies the OU (OrganizationalUnit) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                           |
| vault.pki.rootCa.permittedDnsDomains | string  |         | A comma separated string (or, string array) containing DNS domains for which certificates are allowed to be issued or signed by this CA certificate. Note that subdomains are allowed, as per [RFC 5280 Section 4.2.1.10 - Name Constraints](https://tools.ietf.org/html/rfc5280#section-4.2.1.10)                                                                                                                                       |
| vault.pki.rootCa.postalCode          | string  |         | Specifies the Postal Code values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                       |
| vault.pki.rootCa.province            | string  |         | Specifies the ST (Province) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                     |
| vault.pki.rootCa.signatureBits       | string  |         | Specifies the number of bits to use in the signature algorithm; accepts 256 for SHA-2-256, 384 for SHA-2-384, and 512 for SHA-2-512. Defaults to 0 to automatically detect based on issuer's key length (SHA-2-256 for RSA keys, and matching the curve size for NIST P-Curves). ECDSA and Ed25519 issuers do not follow configuration of the signature_bits value; only RSA issuers will change signature types based on this parameter |
| vault.pki.rootCa.streetAddress       | string  |         | Specifies the Street Address values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                    |
| vault.pki.rootCa.ttl                 | string  |         | Specifies the requested Time To Live (after which the certificate will be expired). This cannot be larger than the engine's max (or, if not set, the system max)                                                                                                                                                                                                                                                                         |

#### Intermediate CA
| Name                                               | Type    | Default | Description                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------|---------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| vault.pki.bootstrapIntermediatesCa                 | bool    | false   | Create Intermediates CA after enabling                                                                                                                                                                                                                                                                                                                                                                                                   |
| vault.pki.intermediatesCa[`i`].altNames            | string  |         | Specifies the requested Subject Alternative Names, in a comma-delimited list. These can be host names or email addresses; they will be parsed into their respective fields                                                                                                                                                                                                                                                               |
| vault.pki.intermediatesCa[`i`].commonName          | string  |         | Specifies the requested CN for the certificate. If more than one common_name is desired, specify the alternative names in the alt_names list                                                                                                                                                                                                                                                                                             |
| vault.pki.intermediatesCa[`i`].country             | string  |         | Specifies the C (Country) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                       |
| vault.pki.intermediatesCa[`i`].excludeCnFromSans   | bool    |         | If true, the given common_name will not be included in DNS or Email Subject Alternate Names (as appropriate). Useful if the CN is not a hostname or email address, but is instead some human-readable identifier                                                                                                                                                                                                                         |
| vault.pki.intermediatesCa[`i`].issuerName          | string  |         | Provides a name to the specified issuer. The name must be unique across all issuers and not be the reserved value default                                                                                                                                                                                                                                                                                                                |
| vault.pki.intermediatesCa[`i`].keyBits             | integer |         | Specifies the number of bits to use for the generated keys. Allowed values are 0 (universal default); with key_type=rsa, allowed values are: 2048 (default), 3072, 4096 or 8192; with key_type=ec, allowed values are: 224, 256 (default), 384, or 521; ignored with key_type=ed25519                                                                                                                                                    |
| vault.pki.intermediatesCa[`i`].keyType             | string  |         | Specifies the desired key type; must be `rsa`, `ed25519` or `ec`                                                                                                                                                                                                                                                                                                                                                                         |
| vault.pki.intermediatesCa[`i`].locality            | string  |         | Specifies the L (Locality) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                      |
| vault.pki.intermediatesCa[`i`].maxLeaseTtl         | string  |         | The maximum lease TTL for this secrets engine                                                                                                                                                                                                                                                                                                                                                                                            |
| vault.pki.intermediatesCa[`i`].mountPath           | string  |         | Specifies the mount path of the PKI. Each Intermediate CA needs to have a dedicated mount path                                                                                                                                                                                                                                                                                                                                           |
| vault.pki.intermediatesCa[`i`].organization        | string  |         | Specifies the O (Organization) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                  |
| vault.pki.intermediatesCa[`i`].ou                  | string  |         | Specifies the OU (OrganizationalUnit) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                           |
| vault.pki.intermediatesCa[`i`].permittedDnsDomains | string  |         | A comma separated string (or, string array) containing DNS domains for which certificates are allowed to be issued or signed by this CA certificate. Note that subdomains are allowed, as per [RFC 5280 Section 4.2.1.10 - Name Constraints](https://tools.ietf.org/html/rfc5280#section-4.2.1.10)                                                                                                                                       |
| vault.pki.intermediatesCa[`i`].postalCode          | string  |         | Specifies the Postal Code values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                       |
| vault.pki.intermediatesCa[`i`].province            | string  |         | Specifies the ST (Province) values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                     |
| vault.pki.intermediatesCa[`i`].signatureBits       | string  |         | Specifies the number of bits to use in the signature algorithm; accepts 256 for SHA-2-256, 384 for SHA-2-384, and 512 for SHA-2-512. Defaults to 0 to automatically detect based on issuer's key length (SHA-2-256 for RSA keys, and matching the curve size for NIST P-Curves). ECDSA and Ed25519 issuers do not follow configuration of the signature_bits value; only RSA issuers will change signature types based on this parameter |
| vault.pki.intermediatesCa[`i`].streetAddress       | string  |         | Specifies the Street Address values in the subject field of the resulting certificate. This is a comma-separated string or JSON array                                                                                                                                                                                                                                                                                                    |
| vault.pki.intermediatesCa[`i`].ttl                 | string  |         | Specifies the requested Time To Live (after which the certificate will be expired). This cannot be larger than the engine's max (or, if not set, the system max)                                                                                                                                                                                                                                                                         |

## Installation

Please be aware that **it is important to note the unseal/recovery key and root token** during installation. This
information appears in the output logs. See the example below:

```text
kubepak.sh: INFO: post-installing vault

================================================================================
Unseal Key 1: <UNSEAL_KEY>

Initial Root Token: <VAULT_ROOT_TOKEN>

Vault initialized with 1 key shares and a key threshold of 1. Please securely
distribute the key shares printed above. When the Vault is re-sealed,
restarted, or stopped, you must supply at least 1 of these keys to unseal it
before it can start servicing requests.

Vault does not store the generated master key. Without at least 1 key to
reconstruct the master key, Vault will remain permanently sealed!

It is possible to generate new unseal keys, provided you have a quorum of
existing unseal keys shares. See "vault operator rekey" for more information.
================================================================================
```
